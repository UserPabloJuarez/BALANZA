DECLARE @FeIni DATETIME, @FeFin DATETIME
SET @FeIni = '2017-01-01 00:00:00.000' SET @FeFin = '2017-03-31 23:59:59.999'
select a.CDAMOSTRA, a.idamostra,ta.nmtipoamostra, vs.nmvs, vsa.UNIDADE, replace(vsa.VLVS, ',','.')
from amostra a
INNER JOIN HISTSITAMOSTRA HREC ON HREC.CDAMOSTRA = A.CDAMOSTRA AND HREC.CDSITAMOSTRA = 2 AND HREC.CDHISTORICO = (SELECT MAX(CDHISTORICO) FROM HISTSITAMOSTRA WHERE CDAMOSTRA = A.CDAMOSTRA AND CDSITAMOSTRA = 2)
left join VSAMOSTRA vsa on vsa.cdamostra = a.cdamostra 
left join VARSAIDA vs on vs.CDVS = vsa.cdvs 
left join TIPOAMOSTRA ta on ta.cdtipoamostra = a.CDTIPOAMOSTRA 
where 
a.CDCLASSEAMOSTRA = 1 and a.FLATIVO = 's'
and a.CDEMPRESASOL in (SELECT E1.CDEMPRESA FROM EMPRESA E1 WHERE E1.IDAUXEMPRESA = 17592)
and hrec.DTSITAMOSTRA >= @FeIni